{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="text-center mb-4">Reconhecimento Facial</h2>
        
        <div class="text-center mb-3">
            <button id="iniciarCamera" class="btn btn-primary">Iniciar Câmera</button>
            <button id="pararCamera" class="btn btn-danger d-none">Parar Câmera</button>
        </div>
        
        <div class="ratio ratio-4x3 mb-3">
            <video id="video" autoplay playsinline class="bg-dark"></video>
        </div>
        
        <div id="resultados" class="mt-3"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const video = document.getElementById('video');
const iniciarBtn = document.getElementById('iniciarCamera');
const pararBtn = document.getElementById('pararCamera');
const resultadosDiv = document.getElementById('resultados');
let stream = null;
let intervalId = null;

iniciarBtn.addEventListener('click', iniciarCamera);
pararBtn.addEventListener('click', pararCamera);

function iniciarCamera() {
    navigator.mediaDevices.getUserMedia({ 
        video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }, 
        audio: false 
    })
    .then(function(s) {
        stream = s;
        video.srcObject = stream;
        iniciarBtn.classList.add('d-none');
        pararBtn.classList.remove('d-none');
        
        // Iniciar reconhecimento a cada 2 segundos
        intervalId = setInterval(reconhecerRosto, 2000);
    })
    .catch(function(err) {
        console.error("Erro ao acessar câmera:", err);
        resultadosDiv.innerHTML = `
            <div class="alert alert-danger">
                Erro ao acessar a câmera: ${err.message || 'Verifique as permissões da câmera'}
            </div>
        `;
    });
}

function pararCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
    video.srcObject = null;
    iniciarBtn.classList.remove('d-none');
    pararBtn.classList.add('d-none');
    resultadosDiv.innerHTML = '';
}

function reconhecerRosto() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    const imageData = canvas.toDataURL('image/jpeg');
    
    fetch("/api/reconhecer", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ image: imageData })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erro na requisição');
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.resultados.length > 0) {
            let html = '';
            data.resultados.forEach(resultado => {
                const status = resultado.registrado ? 
                    '<span class="badge bg-success">Registrado</span>' : 
                    '<span class="badge bg-warning text-dark">Já registrado hoje</span>';
                
                html += `
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">${resultado.nome}</h5>
                        <p class="card-text">
                            Turno: ${resultado.turno}<br>
                            Turma: ${resultado.turma}<br>
                            Confiança: ${resultado.confianca.toFixed(2)}<br>
                            ${status}
                        </p>
                    </div>
                </div>
                `;
            });
            
            resultadosDiv.innerHTML = html;
        } else if (data.success) {
            resultadosDiv.innerHTML = `
                <div class="alert alert-info">
                    Nenhum rosto reconhecido. ${data.timestamp}
                </div>
            `;
        } else {
            resultadosDiv.innerHTML = `
                <div class="alert alert-danger">
                    ${data.message}
                </div>
            `;
        }
    })
    .catch(error => {
        resultadosDiv.innerHTML = `
            <div class="alert alert-danger">
                Erro no reconhecimento: ${error.message || 'Tente novamente'}
            </div>
        `;
    });
}

// Parar a câmera quando a página for fechada
window.addEventListener('beforeunload', pararCamera);
</script>
{% endblock %}