{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <h2 class="text-center mb-4">Relatórios de Atrasos</h2>
        
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Gerenciar Turmas</span>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#turmaModal">
                    Adicionar Turma
                </button>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2 mb-3">
                    {% for turma in turmas %}
                    <button class="btn btn-outline-primary turma-btn" data-turma="{{ turma }}">
                        {{ turma }}
                    </button>
                    {% endfor %}
                </div>
                
                <div id="turmaSelecionada" class="text-center fw-bold mb-2"></div>
                <div id="alunosTurma" class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Turno</th>
                                <th>Atrasos</th>
                                <th>Tempo Total</th>
                            </tr>
                        </thead>
                        <tbody id="alunosLista">
                            <!-- Preenchido por JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="text-center">
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#limparModal">
                Limpar Todos os Registros
            </button>
        </div>
    </div>
</div>

<!-- Modal para adicionar turma -->
<div class="modal fade" id="turmaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Nova Turma</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="novaTurma" class="form-label">Nome da Turma:</label>
                    <input type="text" class="form-control" id="novaTurma">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Turmas Existentes:</label>
                    <select class="form-select" id="turmasExistentes">
                        {% for turma in turmas %}
                        <option value="{{ turma }}">{{ turma }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" id="adicionarTurma">Adicionar</button>
                <button type="button" class="btn btn-danger" id="removerTurma">Remover Selecionada</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para limpar registros -->
<div class="modal fade" id="limparModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Limpar Registros</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Atenção!</strong> Esta ação não pode ser desfeita. Todos os registros de atrasos serão apagados.
                </div>
                <div class="mb-3">
                    <label for="senhaLimpar" class="form-label">Digite a senha para confirmar:</label>
                    <input type="password" class="form-control" id="senhaLimpar">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="confirmarLimpeza">Confirmar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar alunos da primeira turma ao carregar
    const primeiraTurma = document.querySelector('.turma-btn')?.dataset.turma;
    if (primeiraTurma) {
        carregarAlunos(primeiraTurma);
        document.getElementById('turmaSelecionada').textContent = `Turma: ${primeiraTurma}`;
    }
    
    // Event listeners para botões de turma
    document.querySelectorAll('.turma-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const turma = this.dataset.turma;
            document.getElementById('turmaSelecionada').textContent = `Turma: ${turma}`;
            carregarAlunos(turma);
        });
    });
    
    // Gerenciamento de turmas
    document.getElementById('adicionarTurma').addEventListener('click', function() {
        const novaTurma = document.getElementById('novaTurma').value.trim();
        if (!novaTurma) {
            alert('Digite o nome da turma');
            return;
        }
        
        fetch("/api/turmas", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nome: novaTurma })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Erro ao adicionar turma: ' + (error.message || 'Tente novamente'));
        });
    });
    
    document.getElementById('removerTurma').addEventListener('click', function() {
        const turma = document.getElementById('turmasExistentes').value;
        if (!confirm(`Tem certeza que deseja remover a turma ${turma}?`)) return;
        
        fetch("/api/turmas", {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nome: turma })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Erro ao remover turma: ' + (error.message || 'Tente novamente'));
        });
    });
    
    // Limpar registros
    document.getElementById('confirmarLimpeza').addEventListener('click', function() {
        const senha = document.getElementById('senhaLimpar').value;
        
        fetch("/api/limpar_registros", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ senha: senha })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert(data.message);
                const modal = bootstrap.Modal.getInstance(document.getElementById('limparModal'));
                modal.hide();
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            alert('Erro ao limpar registros: ' + (error.message || 'Tente novamente'));
        });
    });
});

function carregarAlunos(turma) {
    fetch("/relatorios")
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Encontrar os dados da turma específica
            const scriptTag = Array.from(doc.querySelectorAll('script[type="application/json"]'))
                .find(script => script.dataset.turma === turma);
            
            if (!scriptTag) {
                document.getElementById('alunosLista').innerHTML = '<tr><td colspan="4">Nenhum aluno encontrado</td></tr>';
                return;
            }
            
            const alunos = JSON.parse(scriptTag.textContent);
            const tbody = document.getElementById('alunosLista');
            tbody.innerHTML = '';
            
            if (alunos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Nenhum aluno encontrado</td></tr>';
                return;
            }
            
            alunos.forEach(aluno => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${aluno.nome}</td>
                    <td>${aluno.turno}</td>
                    <td>${aluno.total_atrasos}</td>
                    <td>${aluno.tempo_atraso}</td>
                `;
                tbody.appendChild(tr);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar alunos:', error);
            document.getElementById('alunosLista').innerHTML = '<tr><td colspan="4">Erro ao carregar dados</td></tr>';
        });
}
</script>

{% for turma, alunos in dados_por_turma.items() %}
<script type="application/json" data-turma="{{ turma }}">
{{ alunos|tojson }}
</script>
{% endfor %}
{% endblock %}